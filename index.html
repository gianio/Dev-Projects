<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SnowMapper</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        * { 
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'DM Sans', sans-serif;
            overflow: hidden; 
            background: #0f0f0f;
            color: #fff;
            -webkit-user-select: none;
            user-select: none;
        }

        .mono { font-family: 'Space Mono', monospace; }

        /* Smooth animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .fade-in-up { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .slide-in-right { animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Gradient mesh background */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Glass morphism */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-dark {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        .custom-scroll { -webkit-overflow-scrolling: touch; }

        /* Map markers */
        .marker-dot {
            width: 16px; height: 16px; border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4), 0 0 0 0 rgba(255,255,255,0.4);
            animation: pulse-marker 2s infinite;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .marker-dot:active { transform: scale(1.3); }
        
        @keyframes pulse-marker {
            0%, 100% { box-shadow: 0 4px 12px rgba(0,0,0,0.4), 0 0 0 0 rgba(255,255,255,0.4); }
            50% { box-shadow: 0 4px 12px rgba(0,0,0,0.4), 0 0 0 8px rgba(255,255,255,0); }
        }

        .marker-photo {
            width: 48px; height: 48px; border-radius: 16px;
            border: 2px solid #fff;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .marker-photo:active { transform: scale(1.15); }

        /* Bottom sheet */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a1a;
            border-radius: 32px 32px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh;
            z-index: 3000;
        }
        .bottom-sheet.open { transform: translateY(0); }

        /* Pill handle */
        .sheet-handle {
            width: 40px;
            height: 5px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            margin: 12px auto 20px;
        }

        /* Category cards */
        .category-card {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .category-card:active { transform: scale(0.95); }
        .category-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .category-card.selected::before { opacity: 1; }

        /* Floating action button */
        .fab {
            position: fixed;
            right: 20px;
            bottom: 32px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .fab:active { transform: scale(0.9); }

        /* Feed overlay */
        .feed-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 2900;
        }
        .feed-overlay.visible { opacity: 1; pointer-events: auto; }

        /* Chip styles */
        .chip {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1.5px solid transparent;
        }
        .chip:active { transform: scale(0.95); }

        /* Leaflet overrides */
        .leaflet-container { background: #0a0a0a; }
        .leaflet-control-zoom { border: none !important; }
        .leaflet-control-zoom a {
            background: rgba(255,255,255,0.1) !important;
            backdrop-filter: blur(10px);
            color: white !important;
            border: none !important;
            width: 48px !important;
            height: 48px !important;
            line-height: 48px !important;
            font-size: 20px !important;
        }
        .leaflet-control-attribution { display: none; }

        /* Status bar safe area */
        @supports(padding: max(0px)) {
            .safe-top { padding-top: max(env(safe-area-inset-top), 0px); }
            .safe-bottom { padding-bottom: max(env(safe-area-inset-bottom), 0px); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo } = React;

        // ==================== CONFIG ====================

        const CATEGORIES = {
            snow_amount: { 
                id: 'snow_amount',
                label: 'Snow Amount', 
                icon: 'fa-layer-group',
                color: '#3b82f6',
                gradient: 'from-blue-500 to-cyan-500',
                options: [
                    { value: 'sharks', label: 'Visible Sharks' },
                    { value: 'low_coverage', label: 'Low Coverage' },
                    { value: 'good_coverage', label: 'Good Coverage' },
                    { value: 'deep', label: 'Deep' }
                ]
            },
            snow_type: {
                id: 'snow_type',
                label: 'Snow Type',
                icon: 'fa-snowflake',
                color: '#8b5cf6',
                gradient: 'from-purple-500 to-pink-500',
                options: [
                    { value: 'powder', label: 'Powder' },
                    { value: 'wind_crust', label: 'Wind Crust' },
                    { value: 'sun_crust', label: 'Sun Crust' },
                    { value: 'wet_heavy', label: 'Wet / Heavy' },
                    { value: 'ice', label: 'Ice' }
                ]
            },
            hazards: {
                id: 'hazards',
                label: 'Hazards',
                icon: 'fa-triangle-exclamation',
                color: '#ef4444',
                gradient: 'from-red-500 to-orange-500',
                options: [
                    { value: 'slab', label: 'Slab Avalanche' },
                    { value: 'loose', label: 'Loose Wet' },
                    { value: 'glide', label: 'Glide Crack' },
                    { value: 'whumpf', label: 'Whumpf Sound' }
                ],
                sizes: ['Small', 'Medium', 'Large'],
                triggers: ['Natural', 'Skier', 'Remote']
            },
            people: {
                id: 'people',
                label: 'People & Tracks',
                icon: 'fa-users',
                color: '#a855f7',
                gradient: 'from-purple-500 to-indigo-500'
            }
        };

        const SWISS_REGIONS = [
            { lat: 46.2, lng: 7.6, spread: 0.4 },
            { lat: 46.6, lng: 7.9, spread: 0.3 },
            { lat: 46.7, lng: 8.6, spread: 0.25 },
            { lat: 46.6, lng: 9.5, spread: 0.5 },
            { lat: 46.9, lng: 8.4, spread: 0.25 }
        ];

        const FRIENDS = ['alpine_explorer', 'powder_hunter', 'ski_sarah'];
        const USERNAMES = ['alpine_explorer', 'powder_hunter', 'ski_sarah', 'mountain_mike', 'freeride_fred', 'peak_pete'];
        const AVATARS = ['https://i.pravatar.cc/150?img=68', 'https://i.pravatar.cc/150?img=52', 'https://i.pravatar.cc/150?img=12', 'https://i.pravatar.cc/150?img=33'];
        const SNOW_IMGS = [
            'https://images.unsplash.com/photo-1551582045-6ec9c11d8697?w=600',
            'https://images.unsplash.com/photo-1491002052546-bf38f186af56?w=600',
            'https://images.unsplash.com/photo-1548777123-e216912df7d8?w=600',
            'https://images.unsplash.com/photo-1520625981442-20c2d3a9856f?w=600'
        ];
        const TITLES = ["Matterhorn North", "Verbier Powder", "Andermatt Bowl", "Zermatt Couloir", "Saas-Fee Glacier"];
        const DESCRIPTIONS = ["Epic powder day!", "Watch for sharks below 2000m", "Perfect conditions", "Wind affected at ridge", "Heavy wet snow by noon"];

        // Generate demo data
        const generateReports = (count) => {
            const reports = [];
            const today = Date.now();
            for (let i = 0; i < count; i++) {
                const region = SWISS_REGIONS[Math.floor(Math.random() * SWISS_REGIONS.length)];
                const username = USERNAMES[i % USERNAMES.length];
                const categoryId = Object.keys(CATEGORIES)[Math.floor(Math.random() * 4)];
                
                reports.push({
                    id: i,
                    name: TITLES[i % TITLES.length],
                    description: DESCRIPTIONS[i % DESCRIPTIONS.length],
                    lat: region.lat + (Math.random() - 0.5) * region.spread,
                    lng: region.lng + (Math.random() - 0.5) * region.spread,
                    timestamp: today - (Math.floor(Math.random() * 20) * 86400000),
                    photo: SNOW_IMGS[i % SNOW_IMGS.length],
                    categoryId,
                    user: {
                        name: username,
                        avatar: AVATARS[i % AVATARS.length],
                        isFriend: FRIENDS.includes(username)
                    }
                });
            }
            return reports.sort((a, b) => b.timestamp - a.timestamp);
        };

        const DEMO_DATA = generateReports(100);

        // ==================== HELPERS ====================
        
        const calculateDistance = (lat1, lng1, lat2, lng2) => {
            if (!lat1 || !lat2) return null;
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        };

        // ==================== COMPONENTS ====================

        const FeedCard = ({ report, onClick, userLocation }) => {
            const category = CATEGORIES[report.categoryId];
            const distance = userLocation ? calculateDistance(userLocation.lat, userLocation.lng, report.lat, report.lng) : null;
            const daysAgo = Math.floor((Date.now() - report.timestamp) / 86400000);

            return (
                <div onClick={onClick} className="mb-4 cursor-pointer active:scale-98 transition-transform">
                    <div className="glass-dark rounded-3xl overflow-hidden">
                        {/* User header */}
                        <div className="p-4 flex items-center gap-3">
                            <div className={`p-[2px] rounded-full ${report.user.isFriend ? 'bg-gradient-to-tr from-yellow-400 to-pink-500' : 'bg-gray-700'}`}>
                                <img src={report.user.avatar} className="w-10 h-10 rounded-full border-2 border-black" />
                            </div>
                            <div className="flex-1 min-w-0">
                                <div className="font-bold text-sm flex items-center gap-1.5">
                                    {report.user.name}
                                    {report.user.isFriend && <i className="fas fa-star text-xs text-yellow-400"></i>}
                                </div>
                                <div className="text-xs text-gray-400 mono">
                                    {distance && `${distance < 1 ? Math.round(distance*1000)+'m' : distance.toFixed(1)+'km'} â€¢ `}
                                    {daysAgo === 0 ? 'Today' : `${daysAgo}d ago`}
                                </div>
                            </div>
                        </div>

                        {/* Photo */}
                        <div className="relative aspect-square bg-black">
                            <img src={report.photo} className="w-full h-full object-cover" />
                            <div className="absolute top-3 right-3 px-3 py-1.5 rounded-full glass text-xs font-bold flex items-center gap-1.5">
                                <i className={`fas ${category.icon}`} style={{ color: category.color }}></i>
                                {category.label}
                            </div>
                        </div>

                        {/* Content */}
                        <div className="p-4">
                            <div className="font-bold text-base mb-1">{report.name}</div>
                            <div className="text-sm text-gray-300">{report.description}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const UploadModal = ({ onClose, onSubmit }) => {
            const [photo, setPhoto] = useState(null);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [form, setForm] = useState({ title: '', description: '', details: '' });

            const handleFile = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => setPhoto(ev.target.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = () => {
                if (!photo || !selectedCategory || !form.title) return;
                onSubmit({
                    name: form.title,
                    description: form.description || "No description",
                    categoryId: selectedCategory,
                    photo,
                    user: { name: 'You', avatar: AVATARS[0], isFriend: false }
                });
                onClose();
            };

            return (
                <div className="fixed inset-0 z-[5000] flex items-end sm:items-center justify-center p-0 sm:p-4" onClick={onClose}>
                    <div className="feed-overlay visible"></div>
                    <div className="relative bg-gradient-to-br from-gray-900 to-black w-full sm:max-w-lg sm:rounded-3xl overflow-hidden shadow-2xl scale-in" 
                         style={{ maxHeight: '90vh', borderRadius: '32px 32px 0 0' }}
                         onClick={e => e.stopPropagation()}>
                        
                        {/* Header */}
                        <div className="gradient-bg p-6 relative">
                            <button onClick={onClose} className="absolute top-6 right-6 w-10 h-10 glass rounded-full flex items-center justify-center">
                                <i className="fas fa-times text-lg"></i>
                            </button>
                            <h2 className="text-2xl font-bold">New Report</h2>
                            <p className="text-sm text-white/80 mt-1">Share snow conditions</p>
                        </div>

                        <div className="overflow-y-auto custom-scroll" style={{ maxHeight: 'calc(90vh - 180px)' }}>
                            <div className="p-6 space-y-6">
                                {/* Photo upload */}
                                {!photo ? (
                                    <div onClick={() => document.getElementById('photo-upload').click()} 
                                         className="aspect-video glass-dark rounded-2xl border-2 border-dashed border-white/20 flex flex-col items-center justify-center cursor-pointer active:scale-98 transition">
                                        <i className="fas fa-camera text-4xl mb-3 text-white/40"></i>
                                        <p className="text-sm font-medium text-white/60">Tap to add photo</p>
                                        <input id="photo-upload" type="file" className="hidden" accept="image/*" onChange={handleFile} />
                                    </div>
                                ) : (
                                    <div className="relative aspect-video rounded-2xl overflow-hidden">
                                        <img src={photo} className="w-full h-full object-cover" />
                                        <button onClick={() => setPhoto(null)} 
                                                className="absolute top-3 right-3 w-10 h-10 bg-black/60 backdrop-blur rounded-full flex items-center justify-center">
                                            <i className="fas fa-trash text-sm"></i>
                                        </button>
                                    </div>
                                )}

                                {/* Title */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-400 mb-2">Title *</label>
                                    <input 
                                        type="text"
                                        value={form.title}
                                        onChange={e => setForm({...form, title: e.target.value})}
                                        placeholder="e.g., Epic powder at Matterhorn"
                                        className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-white/30 transition"
                                    />
                                </div>

                                {/* Description */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-400 mb-2">Description</label>
                                    <textarea 
                                        value={form.description}
                                        onChange={e => setForm({...form, description: e.target.value})}
                                        placeholder="Share details about conditions..."
                                        rows="3"
                                        className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-white/30 transition resize-none"
                                    />
                                </div>

                                {/* Category selection */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-400 mb-3">Category *</label>
                                    <div className="grid grid-cols-2 gap-3">
                                        {Object.values(CATEGORIES).map(cat => (
                                            <div key={cat.id}
                                                 onClick={() => setSelectedCategory(cat.id)}
                                                 className={`category-card p-4 rounded-2xl cursor-pointer border-2 transition ${
                                                     selectedCategory === cat.id 
                                                         ? 'border-white/30 glass' 
                                                         : 'border-white/10 glass-dark'
                                                 }`}>
                                                <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${cat.gradient} flex items-center justify-center mb-3`}>
                                                    <i className={`fas ${cat.icon} text-xl`}></i>
                                                </div>
                                                <div className="font-bold text-sm">{cat.label}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Category-specific fields */}
                                {selectedCategory && CATEGORIES[selectedCategory].options && (
                                    <div className="space-y-3">
                                        <label className="block text-sm font-medium text-gray-400">Type</label>
                                        <select className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-white/30">
                                            <option value="">Select type...</option>
                                            {CATEGORIES[selectedCategory].options.map(opt => (
                                                <option key={opt.value} value={opt.value}>{opt.label}</option>
                                            ))}
                                        </select>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Submit */}
                        <div className="p-6 border-t border-white/10">
                            <button onClick={handleSubmit} 
                                    disabled={!photo || !selectedCategory || !form.title}
                                    className="w-full gradient-bg py-4 rounded-2xl font-bold text-lg disabled:opacity-50 active:scale-98 transition shadow-xl">
                                Publish Report
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ==================== MAIN APP ====================

        function App() {
            const [reports, setReports] = useState(DEMO_DATA);
            const [showFeed, setShowFeed] = useState(false);
            const [showUpload, setShowUpload] = useState(false);
            const [selectedReport, setSelectedReport] = useState(null);
            const [friendsOnly, setFriendsOnly] = useState(false);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [userLocation, setUserLocation] = useState(null);
            const [zoom, setZoom] = useState(9);

            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const markersRef = useRef([]);
            const userMarkerRef = useRef(null);

            const filteredReports = useMemo(() => {
                let filtered = reports.filter(r => {
                    if (friendsOnly && !r.user.isFriend) return false;
                    if (selectedCategory && r.categoryId !== selectedCategory) return false;
                    return true;
                });
                if (userLocation) {
                    filtered = filtered.map(r => ({
                        ...r,
                        distance: calculateDistance(userLocation.lat, userLocation.lng, r.lat, r.lng)
                    })).sort((a, b) => a.distance - b.distance);
                }
                return filtered;
            }, [reports, friendsOnly, selectedCategory, userLocation]);

            const enableLocation = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        setUserLocation(loc);
                        if (mapInstance.current) {
                            mapInstance.current.flyTo([loc.lat, loc.lng], 12);
                        }
                    });
                }
            };

            useEffect(() => {
                if (!mapInstance.current && mapRef.current) {
                    const map = L.map(mapRef.current, { zoomControl: false }).setView([46.8, 8.2], 9);
                    L.tileLayer('https://wmts.geo.admin.ch/1.0.0/ch.swisstopo.pixelkarte-farbe/default/current/3857/{z}/{x}/{y}.jpeg', {
                        minZoom: 8, maxZoom: 19
                    }).addTo(map);
                    L.control.zoom({ position: 'bottomright' }).addTo(map);
                    map.on('zoomend', () => setZoom(map.getZoom()));
                    mapInstance.current = map;
                }
            }, []);

            useEffect(() => {
                if (!mapInstance.current) return;
                markersRef.current.forEach(m => m.remove());
                markersRef.current = [];

                filteredReports.forEach(r => {
                    const cat = CATEGORIES[r.categoryId];
                    const isPhoto = zoom >= 12;
                    const html = isPhoto 
                        ? `<div class="marker-photo"><img src="${r.photo}" style="width:100%;height:100%;object-fit:cover;"></div>`
                        : `<div class="marker-dot" style="background:${cat.color}"></div>`;

                    const m = L.marker([r.lat, r.lng], {
                        icon: L.divIcon({ className: 'custom', html, iconSize: isPhoto ? [48,48] : [16,16] })
                    }).addTo(mapInstance.current);

                    m.on('click', () => {
                        setSelectedReport(r);
                        setShowFeed(false);
                    });
                    markersRef.current.push(m);
                });
            }, [filteredReports, zoom]);

            return (
                <div className="h-screen flex flex-col bg-black">
                    {/* Header */}
                    <div className="glass-dark safe-top px-4 py-4 flex items-center justify-between z-[3100]">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 gradient-bg rounded-full flex items-center justify-center">
                                <i className="fas fa-snowflake text-lg"></i>
                            </div>
                            <div className="font-bold text-lg">SnowMapper</div>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={enableLocation} 
                                    className={`w-10 h-10 rounded-full flex items-center justify-center transition ${
                                        userLocation ? 'gradient-bg' : 'glass'
                                    }`}>
                                <i className="fas fa-location-crosshairs text-sm"></i>
                            </button>
                            <button onClick={() => setShowFeed(true)} className="w-10 h-10 glass rounded-full flex items-center justify-center">
                                <i className="fas fa-bars text-sm"></i>
                            </button>
                        </div>
                    </div>

                    {/* Map */}
                    <div className="flex-1 relative">
                        <div ref={mapRef} className="w-full h-full"></div>
                        
                        {/* Category filters */}
                        <div className="absolute top-4 left-4 right-4 flex gap-2 overflow-x-auto no-scrollbar">
                            <button onClick={() => setSelectedCategory(null)} 
                                    className={`chip ${!selectedCategory ? 'bg-white text-black' : 'glass border-white/20'}`}>
                                All
                            </button>
                            {Object.values(CATEGORIES).map(cat => (
                                <button key={cat.id}
                                        onClick={() => setSelectedCategory(selectedCategory === cat.id ? null : cat.id)}
                                        className={`chip ${selectedCategory === cat.id ? 'text-black' : 'glass border-white/20'}`}
                                        style={selectedCategory === cat.id ? { background: cat.color } : {}}>
                                    <i className={`fas ${cat.icon} mr-1.5`}></i>
                                    {cat.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* FAB */}
                    <div className="fab safe-bottom" onClick={() => setShowUpload(true)}>
                        <i className="fas fa-plus text-2xl"></i>
                    </div>

                    {/* Feed bottom sheet */}
                    <div className={`bottom-sheet ${showFeed ? 'open' : ''}`}>
                        <div className="sheet-handle"></div>
                        
                        <div className="px-6 pb-4 flex items-center justify-between">
                            <h2 className="text-2xl font-bold">Feed</h2>
                            <button onClick={() => setShowFeed(false)} className="w-10 h-10 glass rounded-full flex items-center justify-center">
                                <i className="fas fa-times"></i>
                            </button>
                        </div>

                        {/* Friends toggle */}
                        <div className="px-6 pb-4">
                            <div className="glass p-1 rounded-2xl flex gap-1">
                                <button onClick={() => setFriendsOnly(false)} 
                                        className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition ${
                                            !friendsOnly ? 'bg-white text-black' : 'text-white/60'
                                        }`}>
                                    Everyone
                                </button>
                                <button onClick={() => setFriendsOnly(true)} 
                                        className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition flex items-center justify-center gap-2 ${
                                            friendsOnly ? 'bg-white text-black' : 'text-white/60'
                                        }`}>
                                    <i className="fas fa-star text-xs"></i>
                                    Friends
                                </button>
                            </div>
                        </div>

                        <div className="px-6 overflow-y-auto custom-scroll safe-bottom" style={{ maxHeight: 'calc(85vh - 200px)' }}>
                            {filteredReports.map(r => (
                                <FeedCard 
                                    key={r.id} 
                                    report={r} 
                                    onClick={() => {
                                        setSelectedReport(r);
                                        setShowFeed(false);
                                        mapInstance.current?.flyTo([r.lat, r.lng], 14);
                                    }}
                                    userLocation={userLocation}
                                />
                            ))}
                        </div>
                    </div>

                    {/* Overlay */}
                    <div className={`feed-overlay ${showFeed ? 'visible' : ''}`} onClick={() => setShowFeed(false)}></div>

                    {/* Upload modal */}
                    {showUpload && <UploadModal onClose={() => setShowUpload(false)} onSubmit={(data) => {
                        const loc = userLocation || { lat: 46.6, lng: 8.6 };
                        setReports([{ id: Date.now(), lat: loc.lat, lng: loc.lng, timestamp: Date.now(), ...data }, ...reports]);
                    }} />}

                    {/* Report detail (simplified) */}
                    {selectedReport && (
                        <div className="fixed inset-0 z-[4000] flex items-end" onClick={() => setSelectedReport(null)}>
                            <div className="feed-overlay visible"></div>
                            <div className="relative w-full bg-gradient-to-br from-gray-900 to-black rounded-t-3xl scale-in" 
                                 style={{ maxHeight: '80vh' }}
                                 onClick={e => e.stopPropagation()}>
                                <div className="sheet-handle"></div>
                                <div className="px-6 pb-6 overflow-y-auto custom-scroll" style={{ maxHeight: '75vh' }}>
                                    <img src={selectedReport.photo} className="w-full aspect-video object-cover rounded-2xl mb-4" />
                                    <h2 className="text-2xl font-bold mb-2">{selectedReport.name}</h2>
                                    <p className="text-gray-300 mb-4">{selectedReport.description}</p>
                                    <div className="flex items-center gap-3">
                                        <img src={selectedReport.user.avatar} className="w-12 h-12 rounded-full" />
                                        <div>
                                            <div className="font-bold">{selectedReport.user.name}</div>
                                            <div className="text-sm text-gray-400">{CATEGORIES[selectedReport.categoryId].label}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
