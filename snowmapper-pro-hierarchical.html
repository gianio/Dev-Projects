<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnowMapper Pro - Swisstopo Edition</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; overflow: hidden; background: #f1f5f9; }

        /* Animations */
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .pop-in { animation: popIn 0.2s ease-out forwards; }

        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Map Markers */
        .photo-marker {
            width: 50px; height: 50px; border-radius: 50%; border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); overflow: hidden; background: white;
            transition: transform 0.2s;
        }
        .photo-marker:hover { transform: scale(1.2); z-index: 1000 !important; border-color: #3b82f6; }

        .icon-marker {
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
            color: white; font-size: 14px; transition: transform 0.2s;
        }
        .icon-marker:hover { transform: scale(1.2); z-index: 1000; }
        
        /* Swisstopo Attribution Fix */
        .leaflet-control-attribution {
            background: rgba(255, 255, 255, 0.8) !important;
            padding: 0 5px;
            font-size: 10px;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .mobile-bottom-sheet {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 40vh;
                border-radius: 16px 16px 0 0;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo } = React;

        // ==================== 1. CONFIGURATION ====================

        const DATE_FILTERS = { ALL: 'all', YESTERDAY: 'yesterday', THIS_WEEK: 'this_week', LAST_WEEK: 'last_week' };

        // 1. Snow Amount (A)
        const SNOW_AMOUNT = {
            id: 'A', label: 'Snow Amount', icon: 'fa-layer-group', colorClass: 'blue',
            options: [
                { value: 'sharks', label: 'Visible Sharks', icon: 'fa-mountain' },
                { value: 'low_coverage', label: 'Low Coverage', icon: 'fa-minus' },
                { value: 'good_coverage', label: 'Good Coverage', icon: 'fa-check' },
                { value: 'deep', label: 'Deep', icon: 'fa-arrow-down' }
            ]
        };

        // 2. Snow Type (B)
        const SNOW_TYPE = {
            id: 'B', label: 'Snow Type', icon: 'fa-snowflake', colorClass: 'indigo',
            options: [
                { value: 'powder', label: 'Powder' },
                { value: 'wind_crust', label: 'Wind Crust' },
                { value: 'sun_crust', label: 'Sun Crust' },
                { value: 'wet_heavy', label: 'Wet / Heavy' },
                { value: 'ice', label: 'Ice' }
            ]
        };

        // 3. Hazards (C)
        const HAZARD_ALERTS = {
            id: 'C', label: 'Hazards', icon: 'fa-triangle-exclamation', colorClass: 'red',
            options: [
                { value: 'slab', label: 'Slab Avalanche' },
                { value: 'loose', label: 'Loose Wet' },
                { value: 'glide', label: 'Glide Crack' },
                { value: 'whumpf', label: 'Whumpf Sound' }
            ],
            sizes: ['Small', 'Medium', 'Large', 'Extreme'],
            triggers: ['Natural', 'Skier', 'Remote']
        };

        // 4. People (D)
        const PEOPLE_TRACKS = { id: 'D', label: 'People', icon: 'fa-users', colorClass: 'purple' };

        const CATEGORIES = [SNOW_AMOUNT, SNOW_TYPE, HAZARD_ALERTS, PEOPLE_TRACKS];

        // Extended Demo Data
        const TITLES = [
            "On the way to Rothorn", "Gemsstock North Face", "Morning at Titlis", "Disentis Couloir",
            "Davos Tree Run", "Verbier Backside", "Furka Pass Approach", "Hidden Valley Run",
            "Müstair Valley Tour", "San Bernardino Pass", "Engadin Powder Day", "Arosa Bowl",
            "Laax Freestyle Park", "Andermatt Powder", "Saas-Fee Glacier", "Zermatt Offpiste",
            "Eiger North Face View", "Jungfraujoch Descent", "Aletsch Glacier Tour", "Grindelwald First",
            "Lenzerheide Cruising", "St. Moritz Glamour", "Flims Tree Skiing", "Klosters Backcountry",
            "Silvaplana Windy Ridge", "Pontresina Valley", "Scuol Remote Area", "Val Müstair Hidden",
            "Samnaun Border Run", "Ischgl Connection", "Bettmeralp Quiet", "Riederalp Views",
            "Leukerbad Hot Springs After", "Crans-Montana Sunny", "Nendaz South Face", "Champéry Portes du Soleil",
            "Morgins Family Run", "Les Crosets Steeps", "Anzère Quiet Pistes", "Veysonnaz Tree Line",
            "Haute-Nendaz Powder Stash", "Siviez 4 Vallées", "Thyon Summit", "La Tzoumaz Hidden",
            "Mayens-de-Riddes Local", "Bruson Freeride", "Ovronnaz South", "Saas-Grund Valley",
            "Stalden Junction", "Grächen Sunny", "St. Luc Observatory", "Chandolin High Village",
            "Zinal Glacier", "Evolène Traditional", "Arolla Touring", "Les Haudères Valley",
            "Ferpècle Remote", "Anniviers Secret", "Belalp Car-Free", "Simplon Pass Summit",
            "Ulrichen Quiet", "Goms Valley Classic", "Münster Valley", "Obergesteln Village",
            "Geschinen Hidden", "Bellwald Family", "Fiesch Glacier Express", "Lax Gentle Slopes",
            "Binn Valley Remote", "Bosco Gurin Highest", "Bedretto Valley", "Airolo South Side",
            "Ambri-Piotta Valley", "Disentis Monastery", "Sedrun Oberalp", "Andermatt Realp",
            "Göschenen Valley", "Wassen Classic", "Gurtnellen Quiet", "Erstfeld Valley",
            "Schattdorf Local", "Bürglen Historic", "Altdorf Tell's Town", "Flüelen Lake View",
            "Seelisberg Ridge", "Emmetten Panorama", "Beckenried Cable Car", "Klewenalp Family",
            "Rigi Queen of Mountains", "Vitznau Cogwheel", "Weggis Lakeside", "Engelberg Titlis",
            "Trübsee Mid Station", "Jochpass Border", "Melchsee-Frutt Hidden", "Meiringen Hasliberg",
            "Planplatten Ridge", "Reuti Valley", "Axalp Dramatic", "Grindelwald Terminal",
            "Kleine Scheidegg Classic", "Männlichen Panorama", "Mürren Car-Free", "Gimmelwald Quiet",
            "Stechelberg Valley", "Lauterbrunnen Waterfall", "Wengen Traditional", "Isenfluh Hidden",
            "Wilderswil Valley", "Beatenberg Panorama", "Habkern Local", "Schangnau Emmental",
            "Kemmeriboden Classic", "Heiligenschwendi View", "Niederhorn Summit", "Schynige Platte Historic",
            "First Cliff Walk", "Faulhorn Ridge", "Bachalpsee Lake", "Bussalp High", "Grosse Scheidegg Pass",
            "Schwarzwaldalp Valley", "Rosenlaui Glacier", "Guttannen Remote", "Grimsel Pass High",
            "Nufenen Pass Highest", "Obergoms Valley", "Reckingen Village", "Biel Valley",
            "Ernen Historic", "Ausserbinn Remote", "Binn Mineral", "Lengenbach Famous",
            "Albrun Pass Border", "Devero Italian", "Baceno Valley", "Formazza Waterfall",
            "Riale High Valley", "Kastel Remote", "Tosa Falls", "Crevola Valley",
            "Varzo Border", "Domodossola Gateway", "Visp Junction", "Visperterminen Highest",
            "Gspon Cable Car", "Staldenried Ridge", "Embd Traditional", "Törbel Sunny",
            "Burchen South", "Unterbäch Family", "Eischoll Quiet", "Ergisch Hidden",
            "Bürchen Views", "Zeneggen Vineyard", "Ausserberg Quiet", "Hohtenn Valley",
            "Steg Valley", "Gampel Junction", "Jeizinen Ridge", "Bratsch South",
            "Erschmatt Historic", "Guttet-Feschel Valley", "Ferden Remote", "Kippel Traditional",
            "Wiler Lötschental", "Blatten Valley", "Fafleralp Glacier", "Lötschenlücke Pass",
            "Kandersteg Valley", "Oeschinen Lake", "Blausee Lake", "Adelboden Family",
            "Hahnenmoos Pass", "Lenk Valley", "Metsch High", "Betelberg Summit",
            "Simmenfälle Falls", "Zweisimmen Junction", "Saanenmöser Pass", "Schönried Traditional",
            "Saanen Valley", "Gstaad Glamour", "Lauenen Lake", "Gsteig Border",
            "Col du Pillon Pass", "Les Diablerets Glacier", "Isenau Summit", "Oldenegg Ridge",
            "Arnensee Lake", "Rougemont Valley", "Château-d'Œx Balloon", "Rossinière Village",
            "Montbovon Junction", "Albeuve Valley", "Grandvillard Remote", "Charmey Valley",
            "Jaun Pass Border", "Boltigen Valley", "Weissenbach Quiet", "Oberwil Traditional",
            "Reidenbach Hidden", "Erlenbach Valley", "Därstetten Local", "Frutigen Gateway"
        ];

        const DESCRIPTIONS = [
            "Snow was okay, a lot of other people and I was super exhausted.",
            "Absolutely bombproof stability today. Great lines, but getting tracked out fast.",
            "Watch out for sharks at the bottom, pretty thin cover below 2000m.",
            "Wind affected at the ridge, but soft powder in the bowls.",
            "Heavy wet snow by noon, get out early! Temperatures rising fast.",
            "Saw a small slide on the opposite face. Be careful out there.",
            "Perfect conditions, blue bird day!",
            "Challenging crust layer on top, difficult skiing.",
            "Deep powder stashes still available in tree zones.",
            "Icy conditions on exposed slopes, bring your edges!",
            "Beautiful morning light, but snow turning heavy by 11am.",
            "Tracks everywhere, hard to find fresh lines.",
            "Amazing visibility today, could see all the peaks.",
            "Fog rolled in around midday, navigation tricky.",
            "Best conditions I've seen this season!",
            "Variable snow quality, some sections great, others sketchy.",
            "Crowded weekend, long lift lines.",
            "Early morning was magic, totally worth the wake-up.",
            "Southern exposure already getting slushy.",
            "North faces still holding good snow.",
            "Saw some wildlife on the approach, beautiful day.",
            "Wind transport visible on ridge lines.",
            "Stable snowpack, no signs of instability.",
            "Heard some whumpfing sounds, turned back early.",
            "Spring conditions arriving early this year.",
            "Classic corn snow harvest, timing is everything.",
            "Glacial terrain requires careful route finding.",
            "Tree wells are a real concern today.",
            "Visibility near zero at the summit.",
            "Postcard weather, couldn't ask for better.",
            "Saw avalanche debris from previous days.",
            "Fresh snow overnight, untracked pow!",
            "Exposed rock bands showing through.",
            "Beautiful sunrise tour, started at 5am.",
            "Sunset ski was absolutely stunning.",
            "Full moon illuminated the descent, magical.",
            "Refrozen surface made for fast skiing.",
            "Supportable crust, surprisingly fun to ski.",
            "Breakable crust, very frustrating conditions.",
            "Skiing felt like floating on clouds.",
            "Thin cover, need more snow desperately.",
            "Storm skiing at its finest, snowing hard.",
            "Clearing skies revealed amazing views.",
            "Temperature inversion, warmer up high.",
            "Cold smoke powder, -15°C but worth it.",
            "Spring slush fest, super fun!",
            "Isothermal snowpack, safe but slow.",
            "Wind stripped the ridge bare.",
            "Loaded slopes, signs of recent wind.",
            "Convex rolls looking loaded and scary.",
            "Sheltered aspects holding good snow.",
            "Couloir filled in nicely, good coverage.",
            "Approach was brutal, but descent worth it.",
            "Skinning took longer than expected.",
            "Boot pack required for final section.",
            "Ridge walk was spectacular but exposed.",
            "Descent was faster than anticipated.",
            "Navigation was straightforward today.",
            "Got slightly off route, but found our way.",
            "Beacon check at trailhead, all good.",
            "Partner fell but no injuries, lucky.",
            "Close call with a tree well.",
            "Spotted tracks from yesterday still visible.",
            "Solo tour today, peaceful and meditative.",
            "Big group made logistics challenging.",
            "Split up due to different speeds.",
            "Regrouped at the col as planned.",
            "Summit high five, team stoke was high!",
            "Turned around due to conditions.",
            "Made it to plan B objective instead.",
            "Exceeded expectations today.",
            "About what we expected going in.",
            "Disappointed with snow quality.",
            "Surprised by how good it was!",
            "Locals said it was good, they were right.",
            "Forecast was accurate today.",
            "Forecast was totally wrong!",
            "Warmer than expected.",
            "Colder than expected.",
            "More wind than forecasted.",
            "Less wind than expected, nice surprise.",
            "Sun broke through mid-morning.",
            "Clouds rolled in early afternoon.",
            "Snow started falling around 2pm.",
            "Mixed precip made things interesting.",
            "Rain at parking lot, snow up high.",
            "Spring-like conditions already.",
            "Winter is hanging on up here.",
            "First tracks of the season!",
            "Last run of the trip, bittersweet.",
            "Local beta was super helpful.",
            "Wish we'd known about this spot earlier.",
            "Coming back here for sure.",
            "One and done, not returning.",
            "Classic Swiss backcountry experience.",
            "Felt like skiing in a postcard.",
            "Reminded me of skiing in Colorado.",
            "Totally different from the Rockies.",
            "European Alps have their own vibe.",
            "Couldn't believe we had it to ourselves.",
            "Sharing with dozens of other parties.",
            "Great atmosphere, everyone was friendly.",
            "Some tension over line choice.",
            "Guided group passed us on the skin.",
            "We caught up to them on the descent.",
            "Solo skier looked comfortable.",
            "Beginner group struggling a bit.",
            "Expert level skiing required here.",
            "Intermediate terrain at best.",
            "Perfect for introducing someone to touring.",
            "Not for first-timers, that's for sure.",
            "Gear worked perfectly today.",
            "Had some equipment issues.",
            "Skins weren't gripping well.",
            "Bindings behaved flawlessly.",
            "Poles were the perfect length.",
            "Pack was too heavy in retrospect.",
            "Glad I brought extra layers.",
            "Overdressed, got too warm.",
            "Underdressed, was chilly.",
            "Hydration system froze.",
            "Snacks were perfectly timed.",
            "Should have brought more water.",
            "Energy levels stayed high.",
            "Bonked a bit on the descent.",
            "Second wind kicked in nicely.",
            "Legs were burning on the up.",
            "Cardio was the limiting factor.",
            "Technical skiing was the challenge.",
            "Fitness made it feel easy.",
            "Altitude was noticeable.",
            "Acclimatization helped a lot.",
            "Slight headache from elevation.",
            "No altitude issues today.",
            "Views made every step worth it.",
            "Scenery was breathtaking.",
            "Landscape felt otherworldly.",
            "Photos don't do it justice.",
            "GoPro footage turned out great.",
            "Drone shots were incredible.",
            "Forgot to take photos, too focused.",
            "Stopped every 5 minutes for pictures.",
            "Action shots with friends were fun.",
            "Selfie at the summit was mandatory.",
            "Group photo with the peaks behind.",
            "Wildlife photography opportunity!",
            "Captured the golden hour perfectly.",
            "Light was flat, photos look bland.",
            "Contrast made for dramatic images.",
            "Black and white edit will look sick.",
            "Time lapse of the skin track worked.",
            "Wish I'd brought the real camera.",
            "Phone was good enough today.",
            "Battery died from the cold.",
            "Kept it in my inner pocket, stayed alive.",
            "Charged it with portable battery.",
            "Airplane mode saved battery life.",
            "Signal was surprisingly good up here.",
            "No service, complete disconnect.",
            "Sent location pin from the summit.",
            "Checked weather update mid-tour.",
            "Used offline maps for navigation.",
            "GPS track was helpful on descent.",
            "Old school map and compass only.",
            "Followed established skin track.",
            "Breaking trail was exhausting.",
            "Alternated leads to share the work.",
            "Someone had broken trail yesterday.",
            "Wind had filled in yesterday's track.",
            "Bootpack was well established.",
            "Had to create our own route.",
            "Found a better line than planned.",
            "Stuck to the standard route.",
            "Detoured around a hazard.",
            "Straight line was the best choice.",
            "Traversed to avoid a steep section.",
            "Drop-in point was obvious.",
            "Committed to the line, no turning back.",
            "Skied one at a time for safety.",
            "All went together, no issues.",
            "Regrouped after each pitch.",
            "Non-stop descent, kept momentum."
        ];

        const AVATARS = [
            'https://i.pravatar.cc/150?img=68', 'https://i.pravatar.cc/150?img=52',
            'https://i.pravatar.cc/150?img=12', 'https://i.pravatar.cc/150?img=33',
            'https://i.pravatar.cc/150?img=7', 'https://i.pravatar.cc/150?img=22',
            'https://i.pravatar.cc/150?img=45', 'https://i.pravatar.cc/150?img=64'
        ];

        const SNOW_IMGS = [
            'https://images.unsplash.com/photo-1551582045-6ec9c11d8697?w=600',
            'https://images.unsplash.com/photo-1491002052546-bf38f186af56?w=600',
            'https://images.unsplash.com/photo-1548777123-e216912df7d8?w=600',
            'https://images.unsplash.com/photo-1520625981442-20c2d3a9856f?w=600',
            'https://images.unsplash.com/photo-1483921020237-2ff51e8e4b22?w=600',
            'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=600',
            'https://images.unsplash.com/photo-1605540436563-5bca919ae766?w=600',
            'https://images.unsplash.com/photo-1609137144813-7d9921338f24?w=600'
        ];

        // Swiss Alps regions with realistic coordinates
        const SWISS_REGIONS = [
            { name: 'Valais', lat: 46.2, lng: 7.6, spread: 0.4 },      // Zermatt, Saas-Fee
            { name: 'Bern', lat: 46.6, lng: 7.9, spread: 0.3 },        // Jungfrau, Grindelwald
            { name: 'Uri', lat: 46.7, lng: 8.6, spread: 0.25 },        // Andermatt, Göschenen
            { name: 'Graubünden', lat: 46.6, lng: 9.5, spread: 0.5 },  // Davos, St. Moritz
            { name: 'Ticino', lat: 46.4, lng: 8.8, spread: 0.3 },      // Airolo, Val Bedretto
            { name: 'Vaud', lat: 46.3, lng: 7.1, spread: 0.2 },        // Diablerets, Villars
            { name: 'Central', lat: 46.9, lng: 8.4, spread: 0.25 }     // Engelberg, Titlis
        ];

        // ==================== 2. DATA GENERATOR ====================
        const generateDemoReports = (count) => {
            const reports = [];
            const today = Date.now();

            for (let i = 0; i < count; i++) {
                const daysAgo = Math.floor(Math.random() * 20);
                const timestamp = today - (daysAgo * 86400000);
                const dateStr = new Date(timestamp).toLocaleDateString();

                // Pick a random region for realistic distribution
                const region = SWISS_REGIONS[Math.floor(Math.random() * SWISS_REGIONS.length)];
                const lat = region.lat + (Math.random() - 0.5) * region.spread;
                const lng = region.lng + (Math.random() - 0.5) * region.spread;

                const catKeys = ['A', 'B', 'C', 'D'];
                const mainCat = catKeys[Math.floor(Math.random() * catKeys.length)];

                const categories = { A: null, B: null, C: null, D: null };

                if (mainCat === 'A') {
                    const opt = SNOW_AMOUNT.options[Math.floor(Math.random() * SNOW_AMOUNT.options.length)];
                    categories.A = { value: opt.value, label: opt.label };
                } else if (mainCat === 'B') {
                    const opt = SNOW_TYPE.options[Math.floor(Math.random() * SNOW_TYPE.options.length)];
                    categories.B = { value: opt.value, label: opt.label, depth: Math.floor(Math.random() * 150) + 10 };
                } else if (mainCat === 'C') {
                    const opt = HAZARD_ALERTS.options[Math.floor(Math.random() * HAZARD_ALERTS.options.length)];
                    categories.C = {
                        type: opt.value, label: opt.label,
                        size: HAZARD_ALERTS.sizes[Math.floor(Math.random()*HAZARD_ALERTS.sizes.length)],
                        trigger: HAZARD_ALERTS.triggers[Math.floor(Math.random()*HAZARD_ALERTS.triggers.length)]
                    };
                } else if (mainCat === 'D') {
                    categories.D = Math.floor(Math.random() * 50) + 1;
                }

                reports.push({
                    id: i,
                    name: TITLES[i % TITLES.length],
                    description: DESCRIPTIONS[i % DESCRIPTIONS.length],
                    lat,
                    lng,
                    timestamp,
                    date: dateStr,
                    photo: SNOW_IMGS[i % SNOW_IMGS.length],
                    user: {
                        name: `User ${i}`,
                        avatar: AVATARS[i % AVATARS.length],
                        level: ['Beginner', 'Intermediate', 'Advanced', 'Pro Scout'][Math.floor(Math.random() * 4)]
                    },
                    mainCategory: mainCat,
                    categories: categories
                });
            }
            return reports.sort((a,b) => b.timestamp - a.timestamp);
        };

        const DEMO_DATA = generateDemoReports(200);

        // ==================== 3. HELPERS ====================
        const checkDateFilter = (ts, filter) => {
            const diff = (Date.now() - ts) / (1000 * 3600 * 24);
            if (filter === DATE_FILTERS.YESTERDAY) return diff <= 1;
            if (filter === DATE_FILTERS.THIS_WEEK) return diff <= 7;
            if (filter === DATE_FILTERS.LAST_WEEK) return diff <= 14;
            return true;
        };

        // ==================== 4. COMPONENTS ====================

        // --- UPLOAD MODAL ---
        const UploadModal = ({ onClose, onSubmit }) => {
            const [cat, setCat] = useState(null);
            const [photo, setPhoto] = useState(null);
            const [form, setForm] = useState({
                title: '',
                description: '',
                typeVal: '', 
                depth: 50, 
                size: 'Small', 
                count: 5
            });

            const handleFile = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => setPhoto(ev.target.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = () => {
                if(!cat || !photo || !form.title) return;
                const categories = { A: null, B: null, C: null, D: null };

                if(cat === 'A') {
                    const label = SNOW_AMOUNT.options.find(o=>o.value === form.typeVal)?.label || 'Good Coverage';
                    categories.A = { value: form.typeVal, label };
                }
                if(cat === 'B') {
                    const label = SNOW_TYPE.options.find(o=>o.value === form.typeVal)?.label || 'Powder';
                    categories.B = { value: form.typeVal, label, depth: form.depth };
                }
                if(cat === 'C') {
                    const label = HAZARD_ALERTS.options.find(o=>o.value === form.typeVal)?.label || 'Avalanche';
                    categories.C = { type: form.typeVal, label, size: form.size, trigger: 'Skier' };
                }
                if(cat === 'D') categories.D = parseInt(form.count);

                onSubmit({
                    name: form.title,
                    description: form.description || "No description provided.",
                    mainCategory: cat, 
                    categories, 
                    photo,
                    user: { name: 'You', avatar: 'https://i.pravatar.cc/150?img=68', level: 'New' }
                });
                onClose();
            };

            return (
                <div className="fixed inset-0 z-[5000] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-md rounded-2xl max-h-[90vh] flex flex-col overflow-hidden pop-in">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50 shrink-0">
                            <h3 className="font-bold text-gray-800">New Report</h3>
                            <button onClick={onClose}><i className="fas fa-times"></i></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-6">
                            {/* Photo Upload */}
                            {!photo ? (
                                <div onClick={()=>document.getElementById('u').click()} className="h-32 bg-gray-50 border-2 border-dashed rounded-xl flex items-center justify-center cursor-pointer hover:bg-blue-50 hover:border-blue-400 transition">
                                    <div className="text-center text-gray-400">
                                        <i className="fas fa-camera text-2xl mb-2"></i>
                                        <div className="text-xs font-bold">Upload Photo</div>
                                    </div>
                                    <input id="u" type="file" className="hidden" accept="image/*" onChange={handleFile}/>
                                </div>
                            ) : (
                                <img src={photo} className="w-full h-48 object-cover rounded-xl" />
                            )}

                            {/* Title & Description */}
                            <div className="space-y-3">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase block mb-1">Title</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded font-bold" 
                                        placeholder="e.g. On the way to Rothorn"
                                        value={form.title}
                                        onChange={e => setForm({...form, title: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase block mb-1">Description</label>
                                    <textarea 
                                        className="w-full p-2 border rounded text-sm h-20" 
                                        placeholder="Describe the snow conditions, weather, etc..."
                                        value={form.description}
                                        onChange={e => setForm({...form, description: e.target.value})}
                                    ></textarea>
                                </div>
                            </div>

                            {/* Category Grid */}
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase mb-2 block">Category</label>
                                <div className="grid grid-cols-4 gap-2">
                                    {CATEGORIES.map(c => (
                                        <button key={c.id} onClick={()=>setCat(c.id)} className={`flex flex-col items-center p-3 rounded-lg border transition ${cat===c.id ? `bg-${c.colorClass}-50 border-${c.colorClass}-500 text-${c.colorClass}-700` : 'hover:bg-gray-50 border-gray-200'}`}>
                                            <i className={`fas ${c.icon} text-lg mb-1`}></i>
                                            <span className="text-[10px] font-bold">{c.id}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Dynamic Fields */}
                            {cat && (
                                <div className="space-y-3 bg-gray-50 p-4 rounded-lg">
                                    {(cat === 'A' || cat === 'B' || cat === 'C') && (
                                        <select className="w-full p-2 border rounded" value={form.typeVal} onChange={e=>setForm({...form, typeVal: e.target.value})}>
                                            <option value="">Select Type...</option>
                                            {(cat==='A'?SNOW_AMOUNT:cat==='B'?SNOW_TYPE:HAZARD_ALERTS).options.map(o=><option key={o.value} value={o.value}>{o.label}</option>)}
                                        </select>
                                    )}
                                    {cat === 'B' && (
                                        <div>
                                            <label className="text-xs font-bold">Depth: {form.depth}cm</label>
                                            <input type="range" min="0" max="200" value={form.depth} onChange={e=>setForm({...form, depth: e.target.value})} className="w-full"/>
                                        </div>
                                    )}
                                    {cat === 'C' && (
                                        <div className="flex gap-2">
                                            {HAZARD_ALERTS.sizes.map(s => (
                                                <button key={s} onClick={()=>setForm({...form, size:s})} className={`flex-1 text-xs py-1.5 border rounded transition ${form.size===s?'bg-red-600 text-white':'bg-white hover:bg-gray-50'}`}>{s}</button>
                                            ))}
                                        </div>
                                    )}
                                    {cat === 'D' && <input type="number" placeholder="Count" className="w-full p-2 border rounded" value={form.count} onChange={e=>setForm({...form, count: e.target.value})}/>}
                                </div>
                            )}
                        </div>
                        <div className="p-4 border-t shrink-0">
                            <button onClick={handleSubmit} disabled={!cat || !photo || !form.title} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700 transition">Publish</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- FULL SCREEN POPUP ---
        const ReportPopup = ({ report, onClose }) => {
            const mc = report.mainCategory;
            const c = report.categories;
            let theme = { color: 'text-gray-600', bg: 'bg-gray-100', icon: 'fa-info' };

            if(mc === 'A') theme = { color: 'text-blue-600', bg: 'bg-blue-50', icon: 'fa-layer-group' };
            if(mc === 'B') theme = { color: 'text-indigo-600', bg: 'bg-indigo-50', icon: 'fa-snowflake' };
            if(mc === 'C') theme = { color: 'text-red-600', bg: 'bg-red-50', icon: 'fa-triangle-exclamation' };
            if(mc === 'D') theme = { color: 'text-purple-600', bg: 'bg-purple-50', icon: 'fa-users' };

            return (
                <div className="fixed inset-0 z-[4000] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white rounded-2xl w-full max-w-2xl overflow-hidden shadow-2xl pop-in relative max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 z-10 w-10 h-10 bg-black/50 text-white rounded-full hover:bg-black/70 flex items-center justify-center transition"><i className="fas fa-times text-lg"></i></button>

                        <div className="flex flex-col md:flex-row flex-1 overflow-hidden">
                            {/* Left: Photo */}
                            <div className="md:w-3/5 h-64 md:h-auto relative bg-black shrink-0">
                                <img src={report.photo} className="w-full h-full object-cover" />
                                <div className={`absolute bottom-4 left-4 px-3 py-1 rounded-full text-xs font-bold bg-white/90 shadow ${theme.color}`}>
                                    <i className={`fas ${theme.icon} mr-2`}></i> {mc === 'C' ? 'HAZARD' : 'Report'}
                                </div>
                            </div>

                            {/* Right: Info */}
                            <div className="md:w-2/5 p-6 overflow-y-auto flex flex-col">
                                <div className="mb-4">
                                    <h2 className="text-xl md:text-2xl font-bold text-gray-800 leading-tight">{report.name}</h2>
                                    <div className="text-sm text-gray-500 flex items-center gap-2 mt-1 mb-3">
                                        <i className="far fa-calendar"></i> {report.date}
                                    </div>
                                    <p className="text-sm text-gray-700 leading-relaxed italic border-l-2 pl-3 border-gray-200">
                                        "{report.description}"
                                    </p>
                                </div>

                                <div className="flex-1 space-y-4">
                                    {mc === 'A' && c.A && (
                                        <div className="p-4 bg-blue-50 rounded-xl border border-blue-100">
                                            <div className="text-xs text-blue-500 font-bold uppercase">Coverage</div>
                                            <div className="text-xl font-bold text-blue-900">{c.A.label}</div>
                                        </div>
                                    )}
                                    {mc === 'B' && c.B && (
                                        <div className="space-y-2">
                                            <div className="p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                                                <div className="text-xs text-indigo-500 font-bold uppercase">Snow Type</div>
                                                <div className="text-xl font-bold text-indigo-900">{c.B.label}</div>
                                            </div>
                                            <div className="p-4 bg-gray-50 rounded-xl border border-gray-100 flex justify-between items-center">
                                                <span className="text-gray-600 font-medium">Depth</span>
                                                <span className="text-2xl font-black text-gray-800">{c.B.depth}<span className="text-sm font-normal text-gray-500">cm</span></span>
                                            </div>
                                        </div>
                                    )}
                                    {mc === 'C' && c.C && (
                                        <div className="space-y-2">
                                            <div className="p-4 bg-red-50 rounded-xl border border-red-100">
                                                <div className="text-xs text-red-500 font-bold uppercase">Hazard Type</div>
                                                <div className="text-xl font-bold text-red-900">{c.C.label}</div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div className="p-3 bg-gray-50 rounded-lg text-center">
                                                    <div className="text-xs text-gray-500">Size</div>
                                                    <div className="font-bold">{c.C.size}</div>
                                                </div>
                                                <div className="p-3 bg-gray-50 rounded-lg text-center">
                                                    <div className="text-xs text-gray-500">Trigger</div>
                                                    <div className="font-bold">{c.C.trigger}</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {mc === 'D' && c.D && (
                                        <div className="p-6 bg-purple-50 rounded-xl border border-purple-100 text-center">
                                            <div className="text-4xl font-black text-purple-600">{c.D}</div>
                                            <div className="text-sm font-bold text-purple-400 uppercase">People Spotted</div>
                                        </div>
                                    )}
                                </div>

                                <div className="mt-6 pt-6 border-t flex items-center gap-3 shrink-0">
                                    <img src={report.user.avatar} className="w-10 h-10 rounded-full border border-gray-200" />
                                    <div>
                                        <div className="font-bold text-sm text-gray-800">{report.user.name}</div>
                                        <div className="text-xs text-gray-500">{report.user.level}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- REPORT CARD (Enhanced) ---
        const ReportCard = ({ report, onClick, compact }) => {
            const mc = report.mainCategory;
            let badgeColor = 'bg-gray-500';
            let badgeIcon = 'fa-circle';
            
            if(mc === 'A') { badgeColor = 'bg-blue-600'; badgeIcon = 'fa-layer-group'; }
            if(mc === 'B') { badgeColor = 'bg-indigo-600'; badgeIcon = 'fa-snowflake'; }
            if(mc === 'C') { badgeColor = 'bg-red-600'; badgeIcon = 'fa-triangle-exclamation'; }
            if(mc === 'D') { badgeColor = 'bg-purple-600'; badgeIcon = 'fa-users'; }

            if (compact) {
                return (
                    <div onClick={onClick} className="flex gap-3 p-3 border rounded-lg hover:shadow-md cursor-pointer transition bg-white">
                        <img src={report.photo} className="w-16 h-16 object-cover rounded bg-gray-100 shrink-0" />
                        <div className="min-w-0 flex-1">
                            <div className="font-bold text-sm truncate">{report.name}</div>
                            <div className="text-xs text-gray-500 truncate">{report.description}</div>
                            <div className="flex items-center gap-2 mt-1">
                                <span className={`${badgeColor} text-white px-2 py-0.5 rounded text-[10px] font-bold`}>
                                    <i className={`fas ${badgeIcon} mr-1`}></i>{mc}
                                </span>
                                <span className="text-[10px] text-gray-400">{report.date}</span>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div onClick={onClick} className="bg-white rounded-xl shadow-md hover:shadow-xl transition cursor-pointer overflow-hidden border border-gray-100">
                    <div className="relative h-48">
                        <img src={report.photo} className="w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                        <div className={`absolute top-3 right-3 ${badgeColor} text-white px-3 py-1 rounded-full text-xs font-bold`}>
                            <i className={`fas ${badgeIcon} mr-1`}></i>{mc}
                        </div>
                        <div className="absolute bottom-3 left-3 right-3">
                            <h3 className="text-white font-bold text-lg mb-1 truncate">{report.name}</h3>
                            <p className="text-white/80 text-xs truncate">{report.description}</p>
                        </div>
                    </div>
                    <div className="p-4">
                        <div className="flex items-center justify-between text-xs text-gray-500">
                            <div className="flex items-center gap-2">
                                <img src={report.user.avatar} className="w-6 h-6 rounded-full" />
                                <span>{report.user.name}</span>
                            </div>
                            <span>{report.date}</span>
                        </div>
                    </div>
                </div>
            );
        };

        // ==================== 5. MAIN APP ====================

        function App() {
            const [reports, setReports] = useState(DEMO_DATA);
            const [activeCat, setActiveCat] = useState(null); 
            const [timeFilter, setTimeFilter] = useState(DATE_FILTERS.ALL);
            const [subFilters, setSubFilters] = useState({}); 

            const [selectedReport, setSelectedReport] = useState(null);
            const [showUpload, setShowUpload] = useState(false);
            const [showMobileList, setShowMobileList] = useState(false);
            const [zoom, setZoom] = useState(9);

            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const markersRef = useRef([]);
            const heatLayerRef = useRef(null);

            const filteredReports = useMemo(() => {
                return reports.filter(r => {
                    if(!checkDateFilter(r.timestamp, timeFilter)) return false;
                    if(activeCat && r.mainCategory !== activeCat) return false;
                    if(activeCat) {
                        const filterVal = subFilters[activeCat];
                        if(filterVal) {
                            if(activeCat === 'A' && r.categories.A?.value !== filterVal) return false;
                            if(activeCat === 'B' && r.categories.B?.value !== filterVal) return false;
                            if(activeCat === 'C' && r.categories.C?.type !== filterVal) return false;
                        }
                    }
                    return true;
                });
            }, [reports, activeCat, timeFilter, subFilters]);

            const handleNewReport = (data) => {
                const newR = {
                    id: Date.now(),
                    lat: 46.6, lng: 8.6,
                    timestamp: Date.now(),
                    date: 'Just Now',
                    ...data
                };
                setReports([newR, ...reports]);
                if(mapInstance.current) mapInstance.current.flyTo([46.6, 8.6], 13);
            };

            // --- MAP INIT (SWISSTOPO) ---
            useEffect(() => {
                if(!mapInstance.current && mapRef.current) {
                    const map = L.map(mapRef.current, { zoomControl: false }).setView([46.8, 8.2], 9);
                    
                    L.tileLayer('https://wmts.geo.admin.ch/1.0.0/ch.swisstopo.pixelkarte-farbe/default/current/3857/{z}/{x}/{y}.jpeg', {
                        attribution: '&copy; <a href="https://www.swisstopo.admin.ch/">swisstopo</a>',
                        minZoom: 8,
                        maxZoom: 19
                    }).addTo(map);
                    
                    L.control.zoom({ position: 'bottomright' }).addTo(map);

                    map.on('zoomend', () => setZoom(map.getZoom()));
                    map.on('click', () => setSelectedReport(null));

                    mapInstance.current = map;
                }
            }, []);

            // Map Rendering
            useEffect(() => {
                if(!mapInstance.current) return;
                const map = mapInstance.current;

                markersRef.current.forEach(m => m.remove());
                markersRef.current = [];
                if(heatLayerRef.current) {
                    try{ heatLayerRef.current.remove(); }catch(e){}
                    heatLayerRef.current = null;
                }

                if(filteredReports.length > 50 && zoom < 10) {
                    const points = filteredReports.map(r => [r.lat, r.lng, 0.6]);
                    heatLayerRef.current = L.heatLayer(points, { radius: 25, blur: 15, maxZoom: 10 }).addTo(map);
                } else {
                    filteredReports.forEach(r => {
                        const mc = r.mainCategory;
                        let color='#888', icon='fa-circle';
                        if(mc==='A'){color='#3b82f6'; icon='fa-layer-group';}
                        if(mc==='B'){color='#6366f1'; icon='fa-snowflake';}
                        if(mc==='C'){color='#ef4444'; icon='fa-triangle-exclamation';}
                        if(mc==='D'){color='#a855f7'; icon='fa-users';}

                        const isPhoto = zoom >= 13;
                        const html = isPhoto ?
                            `<div class="photo-marker" style="border-color:${color}"><img src="${r.photo}" style="width:100%;height:100%;object-fit:cover;"></div>` :
                            `<div class="icon-marker" style="background:${color}"><i class="fas ${icon}"></i></div>`;

                        const m = L.marker([r.lat, r.lng], {
                            icon: L.divIcon({ className: 'custom', html, iconSize: isPhoto?[50,50]:[32,32], iconAnchor: isPhoto?[25,25]:[16,16] })
                        }).addTo(map);

                        m.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            setSelectedReport(r);
                            map.flyTo([r.lat, r.lng], 14);
                        });
                        markersRef.current.push(m);
                    });
                }
                
                setTimeout(() => map.invalidateSize(), 200);

            }, [filteredReports, zoom]);

            return (
                <div className="h-screen flex flex-col">
                    {/* Header */}
                    <div className="h-14 md:h-16 bg-white border-b shadow-sm z-30 flex items-center justify-between px-3 md:px-4 shrink-0">
                        <div className="font-black text-gray-800 flex items-center gap-2 text-sm md:text-base">
                            <i className="fas fa-snowflake text-blue-600"></i> SnowMapper <span className="text-[10px] bg-red-600 text-white px-1 rounded ml-1">CH</span>
                        </div>

                        <div className="flex gap-2">
                             <select className="bg-gray-100 text-xs font-bold py-1.5 md:py-2 px-2 md:px-3 rounded-full outline-none"
                                value={timeFilter} onChange={e=>setTimeFilter(e.target.value)}>
                                <option value={DATE_FILTERS.ALL}>All</option>
                                <option value={DATE_FILTERS.THIS_WEEK}>7d</option>
                                <option value={DATE_FILTERS.YESTERDAY}>24h</option>
                             </select>
                             <button onClick={() => setShowUpload(true)} className="bg-blue-600 text-white px-3 py-1.5 md:py-2 rounded-lg text-xs font-bold hover:bg-blue-700">
                                <i className="fas fa-plus mr-1"></i> <span className="hidden md:inline">Report</span>
                             </button>
                        </div>
                    </div>

                    {/* Category Filters */}
                    <div className="bg-white border-b p-2 flex gap-2 overflow-x-auto shrink-0 z-20 no-scrollbar">
                        <button onClick={()=>{setActiveCat(null); setSubFilters({});}} className={`px-3 md:px-4 py-1.5 rounded-full text-xs font-bold border transition whitespace-nowrap ${!activeCat ? 'bg-gray-800 text-white' : 'bg-white text-gray-600'}`}>All</button>
                        {CATEGORIES.map(c => (
                            <button key={c.id} onClick={()=>{setActiveCat(activeCat===c.id?null:c.id); setSubFilters({});}} className={`px-3 md:px-4 py-1.5 rounded-full text-xs font-bold border flex items-center gap-2 whitespace-nowrap transition ${activeCat===c.id ? `bg-${c.colorClass}-50 text-${c.colorClass}-700 border-${c.colorClass}-500` : 'bg-white text-gray-600 hover:bg-gray-50'}`}>
                                <i className={`fas ${c.icon}`}></i> <span className="hidden sm:inline">{c.label}</span><span className="sm:hidden">{c.id}</span>
                            </button>
                        ))}
                    </div>

                    {/* Sub-filters */}
                    {activeCat && activeCat !== 'D' && (
                        <div className="bg-gray-50 p-2 flex gap-2 overflow-x-auto border-b z-20 shrink-0 pop-in no-scrollbar">
                            {(activeCat==='A'?SNOW_AMOUNT:activeCat==='B'?SNOW_TYPE:HAZARD_ALERTS).options.map(o => (
                                <button key={o.value} onClick={()=>setSubFilters({...subFilters, [activeCat]: subFilters[activeCat]===o.value?null:o.value})}
                                    className={`px-3 py-1 rounded text-[10px] font-bold border transition whitespace-nowrap ${subFilters[activeCat]===o.value ? 'bg-gray-800 text-white' : 'bg-white text-gray-500'}`}>
                                    {o.label}
                                </button>
                            ))}
                        </div>
                    )}

                    {/* Main Content */}
                    <div className="flex-1 flex overflow-hidden relative">
                        {/* Map */}
                        <div className="flex-1 bg-gray-200 relative">
                             <div ref={mapRef} style={{ width: '100%', height: '100%' }}></div>
                             <div className="absolute top-4 left-4 bg-white/90 backdrop-blur px-2 py-1 rounded text-xs font-bold shadow z-[500]">
                                {filteredReports.length} reports {zoom<10 && filteredReports.length>50 && '(Heatmap)'}
                             </div>
                             
                             {/* Mobile: Results Toggle Button */}
                             <button 
                                onClick={() => setShowMobileList(!showMobileList)}
                                className="lg:hidden absolute bottom-4 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg font-bold text-sm z-[500]"
                             >
                                <i className="fas fa-list mr-2"></i>
                                {filteredReports.length} Reports
                             </button>
                        </div>

                        {/* Desktop: Side Panel */}
                        <div className="hidden lg:flex w-96 bg-white border-l shadow-xl z-10 flex-col">
                            <div className="p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border-b">
                                <div className="text-sm font-bold text-gray-800">Reports ({filteredReports.length})</div>
                                <div className="text-xs text-gray-500">Click to view details</div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-3 space-y-3">
                                {filteredReports.map(r => (
                                    <ReportCard key={r.id} report={r} onClick={()=>{setSelectedReport(r); mapInstance.current?.flyTo([r.lat,r.lng],14)}} compact />
                                ))}
                            </div>
                        </div>

                        {/* Mobile: Bottom Sheet */}
                        {showMobileList && (
                            <div className="lg:hidden mobile-bottom-sheet bg-white z-[1000] overflow-hidden flex flex-col">
                                <div className="p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border-b flex justify-between items-center shrink-0">
                                    <div>
                                        <div className="text-sm font-bold text-gray-800">Reports ({filteredReports.length})</div>
                                        <div className="text-xs text-gray-500">Tap to view</div>
                                    </div>
                                    <button onClick={() => setShowMobileList(false)} className="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                                        <i className="fas fa-times text-sm"></i>
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-3 space-y-3">
                                    {filteredReports.slice(0, 20).map(r => (
                                        <ReportCard key={r.id} report={r} onClick={()=>{setSelectedReport(r); setShowMobileList(false); mapInstance.current?.flyTo([r.lat,r.lng],14)}} compact />
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {selectedReport && <ReportPopup report={selectedReport} onClose={()=>setSelectedReport(null)} />}
                    {showUpload && <UploadModal onClose={()=>setShowUpload(false)} onSubmit={handleNewReport} />}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>